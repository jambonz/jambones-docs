<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="../img/favicon.ico">

    
    <title>Modifying the webapp to use https - jambonz</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">

    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="..">jambonz</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">API <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../jambonz/">jambonz Webhooks</a>
</li>

                        
                            
<li >
    <a href="../rest/">jambonz REST API</a>
</li>

                        
                            
<li >
    <a href="../register-hook/">Authenticating SIP clients</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../installing/">Installing</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Integrations <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../teams/">Microsoft Teams</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../data/">Data architecture</a>
                    </li>
                
                
                
                    <li >
                        <a href="../tutorials/">Tutorials</a>
                    </li>
                
                
                
                    <li >
                        <a href="../faqs/">FAQs</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#modifying-the-webapp-to-use-https">Modifying the webapp to use https</a></li>
            <li class="second-level"><a href="#install-nginx-and-allow-traffic">Install NGINX and allow traffic</a></li>
                
            <li class="second-level"><a href="#create-dns-entries">Create DNS entries</a></li>
                
            <li class="second-level"><a href="#configure-nginx">Configure NGINX</a></li>
                
            <li class="second-level"><a href="#generate-tls-certificates">Generate TLS certificates</a></li>
                
            <li class="second-level"><a href="#modify-webapp-and-restart">Modify webapp and restart</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="modifying-the-webapp-to-use-https">Modifying the webapp to use https</h1>
<p>The jambonz webapp is initially configured to run over http on port 3001 of the SBC.  These steps outline the changes needed to run this under https using nginx as the web server and letsencrypt TLS certificates.</p>
<h3 id="install-nginx-and-allow-traffic">Install NGINX and allow traffic</h3>
<ul>
<li>SSH into your Jambonz SBC instance</li>
<li>Install Nginx and certbot</li>
</ul>
<pre><code class="shell">    $ sudo apt update
    $ sudo apt install nginx python3-certbot-nginx
</code></pre>

<ul>
<li>Navigate to your EC2 Dashboard in the AWS console</li>
<li>Select your SBC instance</li>
<li>In the bottom half of the screen, select the Security tab</li>
<li>Under the Security Groups section select the SG link (allow_jambonz_sbc_sip_rtp) to make changes</li>
<li>Under the inbound rules tab click the 'Edit inbound rules' button</li>
<li>Click the 'Add rule' button to add the following rules:</li>
</ul>
<pre><code class="shell">    type: HTTP - source: Anywhere
    type: HTTPS - source: Anywhere
</code></pre>

<h3 id="create-dns-entries">Create DNS entries</h3>
<ul>
<li>Navigate to Route 53, or wherever you have your domains hosted</li>
<li>
<p>Add your desired domains and sub-domains (A records) and point them to the ip address of your SBC instance</p>
<p>you will need to add a sub-domain for the api and the app, eg: </p>
</li>
</ul>
<pre><code>  api.your-domain.com
  app.your-domain.com
</code></pre>

<h3 id="configure-nginx">Configure NGINX</h3>
<ul>
<li>Return to your ssh session and navigate to your nginx sites-available folder</li>
</ul>
<pre><code class="shell">    $ cd /etc/nginx/sites-available
</code></pre>

<ul>
<li>Make a copy of the default config</li>
</ul>
<pre><code class="shell">    $ sudo cp default default.bak
</code></pre>

<ul>
<li>Edit the default config to look like below:</li>
</ul>
<pre><code class="shell">    $ sudo nano default

    server {
        listen 80;
        server_name your_domain.com;  # enter the app sub-domain that you setup in 11
        location / {
            proxy_pass http://localhost:3001; # point the reverse proxy to the webapp on port 3001
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
</code></pre>

<ul>
<li>Save your new configuration</li>
<li>Create another config in your sites-available folder that you are currently in:</li>
</ul>
<pre><code class="shell">    $ sudo nano jambonz-api

    server {
        listen 80;
        server_name api.your_domain.com;  # enter the app sub-domain that you setup in 11
        location / {
            proxy_pass http://localhost:3000; # point the reverse proxy to the api server on port 3000
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
</code></pre>

<ul>
<li>Restart the nginx service</li>
</ul>
<pre><code class="shell">    $ sudo service nginx restart
</code></pre>

<h3 id="generate-tls-certificates">Generate TLS certificates</h3>
<ul>
<li>Install LetsEncrypt certificate using certbot</li>
</ul>
<pre><code class="shell">    $ certbot --nginx
</code></pre>

<ul>
<li>Follow the prompts to select the domain/s you would like to create a certificate for</li>
<li>At the end of the script choose option 2 to make all requests redirect to HTTPS</li>
<li>Test that your new domain works and is certified</li>
<li>Return to the security group settings as discussed above</li>
<li>Change access to port 3000 and 3001 from everywhere to SG</li>
</ul>
<h3 id="modify-webapp-and-restart">Modify webapp and restart</h3>
<ul>
<li>Head back to your ssh terminal</li>
<li>Change ownership of all the files in the app to admin</li>
</ul>
<pre><code>    $ cd ~/app
    $ sudo chmod -R admin:admin . 
</code></pre>

<ul>
<li>Edit the jambonz webapp env</li>
</ul>
<pre><code>    $ cd ~/app/jambonz-webapp
    $ nano .env.local
    change http://ip:3000/v1 to
    https://api.your-domain.com/v1
</code></pre>

<ul>
<li>Rebuild the app</li>
</ul>
<pre><code>    $ cd /home/admin/apps/jambonz-webapp &amp;&amp; sudo npm install --unsafe-perm &amp;&amp; npm run build
</code></pre>

<ul>
<li>Restart the services using pm2</li>
</ul>
<pre><code>    $ pm2 restart all
</code></pre></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
        </p>

        
        
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>
    
    <script>var base_url = ".."</script>
    
    <script src="../js/base.js"></script>
    <script src="../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
